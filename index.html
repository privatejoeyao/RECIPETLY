<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receiptly Professional - PDF Stable</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; display:flex; justify-content:center; align-items:center; min-height:100vh; }
  #workspace { display:flex; gap:20px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  #form { display:flex; flex-direction:column; gap:15px; min-width:350px; }
  input, select, button { padding:8px; font-size:14px; box-sizing:border-box; }
  button { background-color:#007bff; color:white; border:none; cursor:pointer; border-radius:5px; }
  button:hover { background-color:#0056b3; }
  .group { display:flex; gap:10px; }
  .group input { flex:1; }
  #items-container .item-row { display:flex; gap:5px; margin-bottom:5px; }
  .item-row input { flex:1; padding:6px; }
  #preview { flex:1; border:1px solid #ccc; padding:20px; min-width:400px; background:#fff; transform:scale(0.8); transform-origin:top left; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; }
  th { background-color:#f4f4f4; }
  #receipt-id { opacity:0.25; font-size:12px; margin-top:10px; }
</style>
</head>
<body>

<div id="workspace">
  <div id="form">
    <div class="group">
      <input type="text" id="merchant" placeholder="Merchant Name" oninput="updatePreview()">
      <input type="text" id="client" placeholder="Client Name" oninput="updatePreview()">
    </div>

    <label>Items</label>
    <div id="items-container"></div>
    <button type="button" onclick="addItem()">+ Add Item</button>

    <select id="currency" onchange="updatePreview()">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="TWD">TWD</option>
      <option value="JPY">JPY</option>
    </select>

    <button type="button" onclick="generatePDF()">Download PDF</button>
  </div>

  <div id="preview">
    <h2 id="preview-title" style="text-align:center;">Recipient</h2>
    <p><strong>Merchant:</strong> <span id="preview-merchant"></span></p>
    <p><strong>Client:</strong> <span id="preview-client"></span></p>
    <table>
      <thead><tr><th>Item</th><th>Quantity</th><th>Amount</th><th>Total</th></tr></thead>
      <tbody id="preview-items"></tbody>
    </table>
    <p style="text-align:right;"><strong>Grand Total: </strong><span id="preview-total">0.00</span> <span id="preview-currency"></span></p>
    <div id="receipt-id"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ====== 編碼邏輯 ======
let currentReceiptId = '';
const STORAGE_KEY = 'receiptly_codes';

// 隨機英數字
function randomString(length){
  const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let res = "";
  for(let i=0;i<length;i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
  return res;
}

// 今天日期 YYYYMMDD
function getTodayDate(){
  const now = new Date();
  return now.getFullYear().toString() +
         String(now.getMonth()+1).padStart(2,'0') +
         String(now.getDate()).padStart(2,'0');
}

// 計算資料 hash
function generateHash(){
  const merchant = document.getElementById('merchant').value.trim();
  const client = document.getElementById('client').value.trim();
  const items = Array.from(document.querySelectorAll('#items-container .item-row')).map(r=>{
    return r.children[0].value.trim()+'|'+r.children[1].value+'|'+r.children[2].value;
  }).join(';');
  return merchant + '|' + client + '|' + items;
}

// 取得本地儲存的編碼資料
function getStoredCodes(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
}

// 儲存編碼到本地
function saveStoredCodes(codes){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(codes));
}

// 生成或取用編碼
function getReceiptID(){
  const today = getTodayDate();
  const hash = generateHash();
  let codes = getStoredCodes();

  // 如果已有今天的資料編碼且 hash 相同 → 回傳原編碼
  if(codes[today] && codes[today][hash]){
    currentReceiptId = codes[today][hash];
    return currentReceiptId;
  }

  // 如果今天還沒資料 → 初始化
  if(!codes[today]) codes[today] = {};

  // 計算序號
  const serialCounter = Object.keys(codes[today]).length + 1;
  const serialStr = String(serialCounter).padStart(10,'0');

  // 生成隨機英數字部分
  const randomPart1 = randomString(7);
  const randomPart2 = randomString(10);

  currentReceiptId = `RCP${randomPart1}${today}${randomPart2}${serialStr}`;
  codes[today][hash] = currentReceiptId;
  saveStoredCodes(codes);
  return currentReceiptId;
}

// ====== PDF 生成及其他保持不變 ======
function addItem(){
  const container = document.getElementById('items-container');
  const row = document.createElement('div');
  row.classList.add('item-row');
  row.innerHTML = `<input type="text" placeholder="Item" oninput="updatePreview()">
                   <input type="number" placeholder="Qty" min="1" oninput="updatePreview()">
                   <input type="number" placeholder="Amount" min="0" oninput="updatePreview()">`;
  container.appendChild(row);
  updatePreview();
}

function updatePreview(){
  document.getElementById('preview-title').textContent = 'Recipient';
  document.getElementById('preview-merchant').textContent = document.getElementById('merchant').value;
  document.getElementById('preview-client').textContent = document.getElementById('client').value;
  const currency = document.getElementById('currency').value;
  document.getElementById('preview-currency').textContent = currency;

  const rows = document.querySelectorAll('#items-container .item-row');
  const tbody = document.getElementById('preview-items');
  tbody.innerHTML = '';
  let grandTotal = 0;
  rows.forEach(row => {
    const item = row.children[0].value;
    const qty = parseFloat(row.children[1].value) || 0;
    const amt = parseFloat(row.children[2].value) || 0;
    const total = qty * amt;
    grandTotal += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item}</td><td>${qty}</td><td>${amt.toFixed(2)}</td><td>${total.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('preview-total').textContent = grandTotal.toFixed(2);
}

// 生成 PDF
function generatePDF(){
  getReceiptID(); // 確保編碼固定
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');

  let y = 60; // Recipient 初始位置
  const title = 'Recipient';
  const merchant = document.getElementById('merchant').value;
  const client = document.getElementById('client').value;
  const currency = document.getElementById('currency').value;
  const rows = document.querySelectorAll('#items-container .item-row');

  // Recipient 置中
  doc.setFontSize(18);
  doc.text(title, doc.internal.pageSize.getWidth()/2, y, {align:'center'});
  y += 25;

  // Merchant / Client 靠左，行距增加
  doc.setFontSize(12);
  doc.text(`Merchant: ${merchant}`, 40, y);
  doc.text(`Client: ${client}`, 40, y+25);
  y += 60;

  // ITEM 表格大幅下移 30%
  const pageHeight = doc.internal.pageSize.getHeight();
  y += (pageHeight - y) * 0.3; // 下移30%

  // 表格標題
  const colX = [40, 200, 300, 400];
  doc.setFont('helvetica','bold');
  doc.text('Item', colX[0], y);
  doc.text('Qty', colX[1], y);
  doc.text('Amount', colX[2], y);
  doc.text('Total', colX[3], y);
  y += 25;
  doc.setFont('helvetica','normal');

  // 表格內容
  let grandTotal = 0;
  rows.forEach(row => {
    const item = row.children[0].value;
    const qty = parseFloat(row.children[1].value) || 0;
    const amt = parseFloat(row.children[2].value) || 0;
    const total = qty * amt;
    grandTotal += total;
    doc.text(item, colX[0], y);
    doc.text(String(qty), colX[1], y);
    doc.text(amt.toFixed(2), colX[2], y);
    doc.text(total.toFixed(2), colX[3], y);
    y += 30;
  });

  // Grand Total
  doc.text(`Grand Total: ${grandTotal.toFixed(2)} ${currency}`, colX[3]-100, y+10);

  // 流水號
  doc.setFontSize(10);
  doc.setTextColor(0,0,0,0.25);
  doc.text(currentReceiptId, 40, pageHeight-30);

  doc.save(`${title.replace(/\s+/g,'_')}.pdf`);
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  addItem();
  updatePreview();
});
</script>
</body>
</html>
